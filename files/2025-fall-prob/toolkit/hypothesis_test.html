<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>假设检验与P值互动模拟器 (已修正)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for plotting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jStat for statistical calculations -->
    <script src="https://cdn.jsdelivr.net/npm/jstat@1.9.5/dist/jstat.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
        }
        .result-table td, .result-table th {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            text-align: center;
        }
        .result-table .header-col {
            font-weight: bold;
            background-color: #f8fafc;
        }
        .type-I-error { background-color: #fee2e2; } /* red-100 */
        .type-II-error { background-color: #ffedd5; } /* orange-100 */
        .correct-decision { background-color: #dcfce7; } /* green-100 */
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="relative text-center mb-8 py-4">
            <!-- NEW: Back to Home button -->
            <a href="index.html" class="absolute top-1/2 -translate-y-1/2 left-0 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg transition-colors text-sm flex items-center shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                返回主页
            </a>
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">假设检验与P值互动模拟器</h1>
            <p class="text-slate-600 mt-2">直观理解第一类错误 (α) 与第二类错误 (β)</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Panel: Controls -->
            <div class="bg-white rounded-2xl shadow-lg p-6 space-y-6">
                <div>
                    <h2 class="text-lg font-semibold mb-2">1. 设定检验假设</h2>
                    <div class="p-4 bg-slate-50 rounded-lg">
                        <p><b>原假设 H₀:</b> 总体均值 μ = <span id="h0-mean">50</span></p>
                        <p><b>备择假设 H₁:</b> 总体均值 μ ≠ 50 (双侧检验)</p>
                        <p class="text-xs text-slate-500 mt-1">(总体标准差 σ = 10 固定)</p>
                    </div>
                </div>

                <div>
                    <h2 class="text-lg font-semibold mb-2">2. 设定“真实世界”参数</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="true-mean-slider" class="flex justify-between">真实总体均值 (μ): <span id="true-mean-value">50</span></label>
                            <input type="range" id="true-mean-slider" min="40" max="60" step="0.5" value="50" class="w-full">
                            <p class="text-xs text-slate-500 mt-1">拖动滑块，模拟H₀为真(μ=50)或为假(μ≠50)的情况</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-lg font-semibold mb-2">3. 设定检验参数</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="sample-size-slider" class="flex justify-between">样本大小 (n): <span id="sample-size-value">30</span></label>
                            <input type="range" id="sample-size-slider" min="5" max="200" value="30" class="w-full">
                        </div>
                        <div>
                            <label for="alpha-slider" class="flex justify-between">显著性水平 (α): <span id="alpha-value">0.05</span></label>
                            <input type="range" id="alpha-slider" min="0.01" max="0.20" step="0.01" value="0.05" class="w-full">
                        </div>
                    </div>
                </div>

                 <div>
                    <h2 class="text-lg font-semibold mb-2">4. 开始模拟</h2>
                     <div class="grid grid-cols-2 gap-4 mt-4">
                         <button id="run-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md">抽样1次</button>
                         <button id="run-100-button" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md">抽样100次</button>
                         <button id="reset-button" class="col-span-2 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md">重置所有</button>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Visualization & Results -->
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-center">H₀假设下的抽样分布与“真实”抽样分布</h2>
                <div class="relative">
                    <canvas id="test-chart"></canvas>
                </div>
                <div id="last-result" class="text-center mt-4 h-12"></div>
                
                <h2 class="text-xl font-bold text-center mt-6">模拟结果统计</h2>
                <table class="w-full mt-4 result-table">
                    <thead>
                        <tr>
                            <th class="w-1/3"></th>
                            <th colspan="2" class="header-col">我们的决策</th>
                        </tr>
                        <tr>
                            <th class="header-col">真实情况</th>
                            <th class="header-col">不拒绝 H₀</th>
                            <th class="header-col">拒绝 H₀</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="header-col">H₀ 为真</td>
                            <td id="correct-retain" class="correct-decision">0</td>
                            <td id="type1-error" class="type-I-error">0</td>
                        </tr>
                        <tr>
                            <td class="header-col">H₀ 为假</td>
                            <td id="type2-error" class="type-II-error">0</td>
                            <td id="correct-reject" class="correct-decision">0</td>
                        </tr>
                    </tbody>
                </table>
                <div class="text-center mt-2 text-sm text-slate-600 grid grid-cols-2 gap-2">
                    <p>第一类错误率 (α): <span id="type1-rate" class="font-semibold">N/A</span></p>
                    <p>第二类错误率 (β): <span id="type2-rate" class="font-semibold">N/A</span></p>
                    <p class="col-span-2">统计功效 (1-β): <span id="power-rate" class="font-semibold">N/A</span></p>
                </div>
            </div>
        </main>
        <!-- NEW: Footer with copyright -->
        <footer class="mt-12 text-center text-slate-500 text-sm">
            <hr class="mb-6 border-slate-200">
            <p>© 2025 Jiajun Jiang. All Rights Reserved.</p>
            <p class="mt-2">
                本工具包（互动演示中心）采用 
                <a href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh" target="_blank" class="text-blue-600 hover:underline">
                    知识共享署名-非商业性使用 4.0 国际许可协议 (CC BY-NC 4.0)
                </a>
                进行许可。
            </p>
            <p class="mt-1">您可以自由地分享和修改本作品用于非商业性的教学目的，但必须给出适当的署名。</p>
        </footer>
    </div>

    <script>
        // --- Constants & State ---
        const H0_MEAN = 50;
        const POPULATION_STD = 10;
        let stats = {
            correctRetain: 0,
            type1Error: 0,
            type2Error: 0,
            correctReject: 0,
        };

        // --- DOM Elements ---
        const trueMeanSlider = document.getElementById('true-mean-slider');
        const sampleSizeSlider = document.getElementById('sample-size-slider');
        const alphaSlider = document.getElementById('alpha-slider');
        const trueMeanValue = document.getElementById('true-mean-value');
        const sampleSizeValue = document.getElementById('sample-size-value');
        const alphaValue = document.getElementById('alpha-value');
        const runButton = document.getElementById('run-button');
        const run100Button = document.getElementById('run-100-button');
        const resetButton = document.getElementById('reset-button');
        const lastResultEl = document.getElementById('last-result');

        // --- Chart Instance ---
        let testChart;

        // --- Chart & Simulation Logic ---
        function createChart() {
            const ctx = document.getElementById('test-chart').getContext('2d');
            testChart = new Chart(ctx, {
                type: 'line',
                data: {
                    // Labels are now generated dynamically and not set here initially
                    datasets: [
                        { label: 'H₀ 分布', data: [], borderColor: 'rgba(59, 130, 246, 0.8)', fill: false, borderWidth: 2.5, pointRadius: 0 },
                        // DEBUG FIX 2: Changed type to 'bar' for vertical rejection regions
                        { label: '拒绝域 (α)', type: 'bar', data: [], backgroundColor: 'rgba(239, 68, 68, 0.4)', barPercentage: 1.0, categoryPercentage: 1.0 },
                        { label: 'H₁ 分布', data: [], borderColor: 'rgba(168, 85, 247, 0.8)', fill: false, borderWidth: 2, borderDash: [5, 5], pointRadius: 0 },
                        // DEBUG FIX 2: Changed type to 'bar' for vertical beta region
                        { label: '第二类错误 (β)', type: 'bar', data: [], backgroundColor: 'rgba(251, 146, 60, 0.5)', barPercentage: 1.0, categoryPercentage: 1.0 },
                        { label: '样本均值', type: 'scatter', data: [], backgroundColor: 'rgba(22, 163, 74, 1)', pointRadius: 8, pointStyle: 'triangle', rotation: 180 }
                    ]
                },
                options: { 
                    scales: { 
                        y: { beginAtZero: true, grace: '5%' }, 
                        // DEBUG FIX 1: Explicitly set x-axis type to 'linear'
                        x: { 
                            type: 'linear', 
                            title: { display: true, text: '样本均值' } 
                        } 
                    },
                    plugins: { legend: { labels: { usePointStyle: true } } }
                }
            });
        }
        
        function updateChartDistribution() {
            const n = parseInt(sampleSizeSlider.value);
            const alpha = parseFloat(alphaSlider.value);
            const trueMean = parseFloat(trueMeanSlider.value);
            const se = POPULATION_STD / Math.sqrt(n);
            
            const z_critical = jStat.normal.inv(1 - alpha / 2, 0, 1);
            const lowerBound = H0_MEAN - z_critical * se;
            const upperBound = H0_MEAN + z_critical * se;

            const h0_range = se * 5;
            const h1_range = se * 5;
            const minX = Math.min(H0_MEAN - h0_range, trueMean - h1_range);
            const maxX = Math.max(H0_MEAN + h0_range, trueMean + h1_range);
            
            const h0_data = [], h1_data = [], rejection_data = [], type2_error_data = [];
            const step = (maxX - minX) / 200; // Increased points for smoother curves

            for (let i = 0; i <= 200; i++) {
                const x = minX + i * step;
                
                const h0_pdf = jStat.normal.pdf(x, H0_MEAN, se);
                h0_data.push({x: x, y: h0_pdf});
                
                // For rejection region, use the x-value to position the bar
                rejection_data.push({x: x, y: (x <= lowerBound || x >= upperBound) ? h0_pdf : 0});

                if (trueMean !== H0_MEAN) {
                    const h1_pdf = jStat.normal.pdf(x, trueMean, se);
                    h1_data.push({x: x, y: h1_pdf});
                    // For type II error region, use the x-value to position the bar
                    type2_error_data.push({x: x, y: (x > lowerBound && x < upperBound) ? h1_pdf : 0});
                } else {
                    h1_data.push({x: x, y: NaN}); // Don't draw H1 curve if H0 is true
                    type2_error_data.push({x: x, y: 0});
                }
            }

            // Since axis is linear, we don't need 'labels'. We supply {x, y} objects.
            testChart.data.labels = []; 
            testChart.data.datasets[0].data = h0_data;
            testChart.data.datasets[1].data = rejection_data;
            testChart.data.datasets[2].data = h1_data;
            testChart.data.datasets[3].data = type2_error_data;
            
            testChart.update('none');
        }
        
        function runSimulation(times = 1) {
            const trueMean = parseFloat(trueMeanSlider.value);
            const n = parseInt(sampleSizeSlider.value);
            const alpha = parseFloat(alphaSlider.value);
            const se = POPULATION_STD / Math.sqrt(n);
            const z_critical = jStat.normal.inv(1 - alpha / 2, 0, 1);
            const lowerBound = H0_MEAN - z_critical * se;
            const upperBound = H0_MEAN + z_critical * se;

            let lastSampleMean;

            for(let i = 0; i < times; i++) {
                // A more efficient way to get a sample mean from a normal population
                lastSampleMean = jStat.normal.sample(trueMean, se);
            }

            const rejected = lastSampleMean <= lowerBound || lastSampleMean >= upperBound;
            const h0_is_true = trueMean === H0_MEAN;

            // This part is for batch updates (100 samples), so we don't have time to classify each one.
            // We'll just update based on the parameters for a batch.
             if (times > 1) {
                 const z_true = (H0_MEAN - trueMean) / se;
                 if(h0_is_true) {
                    stats.type1Error += times * alpha;
                    stats.correctRetain += times * (1-alpha);
                 } else {
                    const beta = jStat.normal.cdf(z_critical-z_true, 0, 1) - jStat.normal.cdf(-z_critical-z_true, 0, 1);
                    stats.type2Error += times * beta;
                    stats.correctReject += times * (1-beta);
                 }
                 // Round stats to integers after batch processing
                 stats.correctRetain = Math.round(stats.correctRetain);
                 stats.type1Error = Math.round(stats.type1Error);
                 stats.type2Error = Math.round(stats.type2Error);
                 stats.correctReject = Math.round(stats.correctReject);

             } else { // Single run
                 if (h0_is_true) {
                    if (rejected) stats.type1Error++;
                    else stats.correctRetain++;
                } else {
                    if (rejected) stats.correctReject++;
                    else stats.type2Error++;
                }
             }


            const p_value = 2 * (1 - jStat.normal.cdf(Math.abs(lastSampleMean - H0_MEAN) / se, 0, 1));
            
            // The sample mean point is now correctly positioned due to the linear x-axis
            testChart.data.datasets[4].data = [{ x: lastSampleMean, y: 0 }];
            testChart.update();

            lastResultEl.innerHTML = `
                <p>样本均值 = ${lastSampleMean.toFixed(2)}</p>
                <p class="font-bold ${rejected ? 'text-red-600' : 'text-green-600'}">
                    结论: ${rejected ? '拒绝 H₀' : '不拒绝 H₀'}
                </p>
                <p class="text-sm">P-value = ${p_value.toFixed(4)}</p>
            `;

            updateStatsTable();
        }

        function updateStatsTable() {
            document.getElementById('correct-retain').textContent = stats.correctRetain;
            document.getElementById('type1-error').textContent = stats.type1Error;
            document.getElementById('type2-error').textContent = stats.type2Error;
            document.getElementById('correct-reject').textContent = stats.correctReject;

            const h0_true_total = stats.correctRetain + stats.type1Error;
            const h0_false_total = stats.correctReject + stats.type2Error;

            const type1_rate = h0_true_total > 0 ? (stats.type1Error / h0_true_total * 100).toFixed(2) + '%' : 'N/A';
            document.getElementById('type1-rate').textContent = type1_rate;

            const n = parseInt(sampleSizeSlider.value);
            const alpha = parseFloat(alphaSlider.value);
            const trueMean = parseFloat(trueMeanSlider.value);
            const se = POPULATION_STD / Math.sqrt(n);
            const z_critical = jStat.normal.inv(1 - alpha / 2, 0, 1);
            const lowerBound = H0_MEAN - z_critical * se;
            const upperBound = H0_MEAN + z_critical * se;
            
            let beta = NaN;
            if (trueMean !== H0_MEAN) {
                beta = jStat.normal.cdf(upperBound, trueMean, se) - jStat.normal.cdf(lowerBound, trueMean, se);
            }

            const type2_rate = h0_false_total > 0 ? (stats.type2Error / h0_false_total * 100).toFixed(2) + '%' : (isNaN(beta) ? 'N/A' : `理论值: ${(beta * 100).toFixed(2)}%`);
            const power_rate = h0_false_total > 0 ? (stats.correctReject / h0_false_total * 100).toFixed(2) + '%' : (isNaN(beta) ? 'N/A' : `理论值: ${((1 - beta) * 100).toFixed(2)}%`);
            
            document.getElementById('type2-rate').textContent = type2_rate;
            document.getElementById('power-rate').textContent = power_rate;
        }

        function resetAll() {
            stats = { correctRetain: 0, type1Error: 0, type2Error: 0, correctReject: 0 };
            testChart.data.datasets[4].data = [];
            lastResultEl.innerHTML = '';
            updateStatsTable();
            updateChartDistribution();
        }

        // --- Event Listeners ---
        [trueMeanSlider, sampleSizeSlider, alphaSlider].forEach(slider => {
            slider.addEventListener('input', (e) => {
                const elId = e.target.id.replace('-slider', '-value');
                document.getElementById(elId).textContent = e.target.value;
                resetAll();
            });
        });
        
        runButton.addEventListener('click', () => runSimulation(1));
        run100Button.addEventListener('click', () => runSimulation(100));
        resetButton.addEventListener('click', resetAll);

        // --- Initial Load ---
        window.onload = () => {
            createChart();
            updateChartDistribution();
            updateStatsTable();
        };

    </script>
</body>
</html>
